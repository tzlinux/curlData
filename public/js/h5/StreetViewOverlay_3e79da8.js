define("mapapi:widget/api/bmap/streetview/StreetViewOverlay.js",function(t,i,h){function e(t,i){this._position=t,i=i||{},this._imageUrl=i.imageUrl||"",this._dom=i.dom||null,this._anchor=i.anchor||null,this._width=i.width||null,this._height=i.height||null,this._elevation=i.elevation||2,this._sphereZ=null,"number"==typeof i.sphereZ&&(this._sphereZ=i.sphereZ),this._visible=!0}var s=t("mapapi:static/js/lib/tangram-patch.js"),o=t("mapapi:widget/api/bmap/common/ApiUtil.js"),n=t("mapapi:widget/api/bmap/common/Size.js"),a=t("mapapi:widget/api/bmap/streetview/StreetViewUtil.js"),r=s.lang.Event;s.lang.inherits(e,s.lang.Class,"StreetViewOverlay"),s.extend(e.prototype,{init:function(t){this._pano=t,this._data=t._data,this._calcCoords(),this._addToDom(),this._bind()},_calcCoords:function(){var t=this._pano.getPosition();if(t){var i=this._position.lng-t.lng,h=this._position.lat-t.lat,e=i/h,s=180*Math.atan(e)/Math.PI;s=(s+90)%90;var n=0;i>0&&0>h&&(n=90),0>i&&0>h&&(n=180),0>i&&h>0&&(n=270),s+=n,s=Math.round(s),this.angle=s;var r,_=500;null===this._sphereZ?r=25*this._elevation:(r=this._sphereZ,_=Math.sqrt(Math.pow(i,2)+Math.pow(h,2)+Math.pow(r,2)));var d=o.toAngle(Math.asin(r/_));if(d>90?d=90:-90>d&&(d=-90),this._lat=d,a.ifSupportWebGL()){var l=500*Math.cos(o.toRadian(d));l=Math.round(100*l)/100,this.refinedAngle=s+this._data.tiles.dirNorth,this.refinedAngle%=360,this.sphereX=Math.cos(o.toRadian(this.refinedAngle))*l,this.sphereY=500*Math.sin(o.toRadian(d)),this.sphereZ=Math.sin(o.toRadian(this.refinedAngle))*l}}},_addToDom:function(){if(this._dom){this._dom.style.position="absolute",this._pano._overlayContainer.appendChild(this._dom),"number"!=typeof this._width&&(this._width=this._dom.clientWidth),"number"!=typeof this._height&&(this._height=this._dom.clientHeight);var t=new r("onoverlaydomadded");t.overlay=this,this._pano.dispatchEvent(t)}else{if(this._img)return;var i=this._img=new Image;i.style.position="absolute";var h=this;i.onload=function(){h._dom=this,h._pano._overlayContainer.appendChild(this),"number"!=typeof h._width&&(h._width=Math.floor(this.width/2)),"number"!=typeof this._height&&(h._height=Math.floor(this.height/2)),this.style.width=h._width+"px",this.style.height=h._height+"px",h.init(h._pano);var t=new r("onoverlayimgloaded");t.overlay=this,h._pano.dispatchEvent(t),delete h._img},i.src=this._imageUrl}},_bind:function(){if(!this._binded&&this._dom){this._binded=!0;var t=this;s.on(this._dom,"touchstart",function(t){t.stopPropagation(),t.preventDefault()}),s.on(this._dom,"touchend",function(i){t.dispatchEvent(new s.lang.Event("onclick")),i.stopPropagation(),i.preventDefault()})}},setPosition:function(t){this._position=t,this.init(this._pano),this.render(this._zoom,this._tileSize,this._mvMatrix,this._pMatrix)},getPosition:function(){return this._position},show:function(){this._visible=!0,this._dom&&(this.render(this._zoom,this._tileSize,this._mvMatrix,this._pMatrix),this._dom.style.display="")},hide:function(){this._visible=!1,this._dom&&(this._dom.style.display="none")},render:function(t,i,h,e){var s=this._dom;if(this._zoom=t,this._tileSize=i,this._mvMatrix=h,this._pMatrix=e,s&&this._pano&&this._pano._data&&this._visible){var o,n=this.angle;if(o=a.ifSupportWebGL()?this._povToPointGL(h,e):this._povToPoint(n,this._lat,t,i)){var r=this._calcAnchor();s.style.left=o[0]-r.width+"px",s.style.top=o[1]-r.height+"px"}}},_povToPoint:function(t,i,h,e){for(var s=this._pano,o=s.getPov().heading%360;0>o;)o=(o+360)%360;var n=(t-o)%360,a=s._containerSize,r=this._data.tiles.getTotalCols(h),_=360/(r*e);n>180?n-=360:-180>n&&(n+=360);var d=Math.round(a.width/2+n/_),l=Math.round(a.height/2-(i-s.getPov().pitch)/_);return[d,l]},_povToPointGL:function(t,i){if(t&&i){var h=vec4.fromValues(this.sphereX,this.sphereY,this.sphereZ,1),e=vec4.create();if(mat4.multiply(e,t,h),mat4.multiply(e,i,e),e[3]<0)return void(this._dom.style.visibility="hidden");this._dom.style.visibility="";var s=this._pano._containerSize,o=(e[0]/e[3]+1)/2*s.width,n=(1-e[1]/e[3])/2*s.height;return[o,n]}},_calcAnchor:function(){var t=this._anchor?this._anchor.width:this._width/2,i=this._anchor?this._anchor.height:this._height/2;return new n(t,i)},remove:function(){this._dom&&this._dom.parentNode&&this._dom.parentNode.removeChild(this._dom)},destroy:function(){this.remove(),this._dom=null,this._binded=!1}}),h.exports=e});